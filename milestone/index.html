
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://15618-cuda-hash-join.github.io/project-docs/milestone/">
      
      
        <link rel="prev" href="../final/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>Milestone Report - Accelerating Hash Joins on GPUs for OLAP Workloads</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2afb09e1.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#milestone-report" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Accelerating Hash Joins on GPUs for OLAP Workloads" class="md-header__button md-logo" aria-label="Accelerating Hash Joins on GPUs for OLAP Workloads" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Accelerating Hash Joins on GPUs for OLAP Workloads
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Milestone Report
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Accelerating Hash Joins on GPUs for OLAP Workloads" class="md-nav__button md-logo" aria-label="Accelerating Hash Joins on GPUs for OLAP Workloads" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Accelerating Hash Joins on GPUs for OLAP Workloads
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Proposal
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../final/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Final Report
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Milestone Report
    
  </span>
  

      </a>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="milestone-report">Milestone Report</h1>
<p>Zhiping Liao (zhiping2), Siyuan Lin (slin3)</p>
<h1 id="revised-schedule">Revised Schedule</h1>
<table>
<thead>
<tr>
<th>Date</th>
<th>Task</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Mar 27 - April 2</td>
<td>Looked for necessary open source components to simplify the data loading and query plan generation. Integreted them to a loading framework.</td>
<td>Data loading: Siyuan, Query and plan framework: Zhiping</td>
</tr>
<tr>
<td>April 3 - April 9</td>
<td>Continued on building the framework. Implement and benchmark the baseline CPU hash join implementation, looking for rooms to improve.</td>
<td>Basic operators: Siyuan, Framework: Zhiping Liao</td>
</tr>
<tr>
<td>April 10 - 16</td>
<td>Wrote the milestone report. Implemented and optimized the GPU-based hash join.</td>
<td>Report: Zhiping and Siyuan, GPU: Siyuan</td>
</tr>
<tr>
<td>April 17 - 23</td>
<td>Devise and benchmark another 2 techniques. Narrow down the optimizations for the best performance.</td>
<td>Optimizations: Zhiping and Siyuan</td>
</tr>
<tr>
<td>April 24 - 28</td>
<td>Write the final report. In the mean time, assess the attainablity of implementing a hash aggragtor on GPU.</td>
<td>Report: Zhiping and Siyuan</td>
</tr>
</tbody>
</table>
<h1 id="current-progress">Current Progress</h1>
<p>The progress we have made till the milestone generally involves several important points below:</p>
<ul>
<li>Prepared TPC-H dataset:<ul>
<li>Cleaned data.</li>
<li>Transformed into <code>parquet</code> files for faster loading.</li>
<li>Loaded into C++ program using Apache Arrow.</li>
<li>Selected and rewrote a number of queries to suit our project’s need.</li>
</ul>
</li>
<li>Implemented fundamental database executor from scratch, including <code>TableScan</code>, <code>Filter</code>, <code>Join</code>, <code>Project</code>. Verified the correctness of these operators on CPU.</li>
<li>Built database execution pipeline by reading a query plan and translating into corresponding physical operators:<ul>
<li>Used DuckDB to generate query plans and table schemas.</li>
<li>Used <code>sqlglot</code> to parse SQL expressions in predicates and join conditions.</li>
<li>Curated and rewrote queries to limit them into the operators we chose.</li>
<li>Bound query plans and expressions to operators with given table schema.</li>
</ul>
</li>
<li>Zoomed in on the join operator and implemented a baseline GPU join operator using cuco <code>static_multimap</code> host API as starting point.</li>
<li>Optimized the GPU join operator by switching to <code>static_multiset</code> to reduce extra data materialization costs and better and handy API usage.</li>
</ul>
<h1 id="revised-goals-and-delieverables">Revised Goals and Delieverables</h1>
<p>As we were exploring the datasets and assessing the feasibility, we noticed several issues:</p>
<ol>
<li>Semi join and outter join plans result in <code>DELIM</code> joins and scans: 3-way join operators and result reuse, which are non-trivial to support in our framework.</li>
<li>Aggregations are challenging to implement and optimize because 1) it requires a hash table just as normal joins, 2) only simple aggregation functions (<code>min</code>, <code>sum</code>, <code>avg</code>) can be implemented and need static dispatch to achieve ideal performance (one CUDA kernel per each aggregation function). We thus decide to choose aggregations as our bonus target.</li>
<li>Other expressions and operators would add significant amount of work but do not contribute to the goals of our projects. We agreed to drop their supports and continued to emphasis hash joins on GPU.</li>
<li><code>libcudf</code> turns out to be closely couple with the cuDF dataframe representation and its complexity is way beyond our imagination. We settled on NVIDIA’s cuCo (cuCollections) as our references to implement hash join algorithms. However, <code>libcudf</code>'s hash join implementation does provide us with some insights for our design.</li>
</ol>
<p>Based on our observations, we made a few changes to our goals and deliverables:</p>
<ol>
<li>Hash join algorithms will only rely on cuco, not cuDF, as it provides sufficient functionality, customizability and better performance. </li>
<li>Our further operator optimizations will mainly focus on join performance optimization, including but not limited to custom kernel optimizations, reduced data materialization, data movement and kernel execution overlapping.</li>
<li>We will also focus on data-loading or pre-processing before join, as data patterns will affect hash table insertion and lookup, which can indirectly affect cache friendliness and hit rate. This is important for performance speedup.</li>
<li>We change our <strong>bonus points</strong> to implement and refine hash aggregation with a fixed set of functions: <code>sum</code>, <code>min</code>, <code>max</code> and <code>avg</code>.</li>
<li>We want to reduce the supports for other operators and expressions. </li>
</ol>
<h1 id="poster-session-plan">Poster Session Plan</h1>
<p>Our poster session will likely to demonstrate:</p>
<ol>
<li>Background information about our project and why it is challenging;</li>
<li>The architecture of the project: what tools are used and how they are chained together;</li>
<li>The speedup and performance comparison between different versions;</li>
<li>A deep analysis of how we progressively diagnose the performance and arrive at the final solution.</li>
</ol>
<h1 id="preliminary-results">Preliminary Results</h1>
<p>Currently as we only focus on join, so the SQL query for development and benchmark only involves one join, and it is sufficient for us to benchmark and improve on its performance. The query we focus on currently is a simplified TPCH Q21, which eliminates aggregation and sub-query, and only focus on join.</p>
<h2 id="q21-simplified-query">Q21 Simplified Query</h2>
<p>Setup:</p>
<ul>
<li>TPC-H dataset scale factor: 10.</li>
<li>Machine: <code>g4dn.xlarge</code>, NVIDIA T4 Tensor Core, 4 vCPUs, 16 GB Memory.</li>
<li>Environment: <code>amazon/Deep Learning Base OSS Nvidia Driver GPU AMI (Ubuntu 22.04)</code></li>
<li>Here we use cuco as the hash table library, and it provides host API that can be called on CPU, and devices API that can only be called inside a kernel.</li>
</ul>
<pre><code class="language-sql">select
  s_suppkey, l_orderkey
from
  supplier,
  lineitem l1,
where
  s_suppkey = l1.l_suppkey
  and s_nationkey = 1
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>CPU Join</th>
<th>GPU Join with multimap</th>
<th>GPU Join with multiset</th>
</tr>
</thead>
<tbody>
<tr>
<td>Time</td>
<td>4.8s</td>
<td>5.1s</td>
<td>3.5s</td>
</tr>
</tbody>
</table>
<p>Analysis:</p>
<ul>
<li>For scale factor 10, the large table <code>lineitem</code> would contain 6M rows, and would be as large as 5GB.</li>
<li><code>static_multimap</code> is worse because it introduces extra data materialization costs due to the API, whenever there is match, it can only output the build table match, but not specifying probing matching. <code>static_multiset</code>  works as we can encode <code>(Key, row idx)</code> as the key for set, and it could give us correct results without extra looking up the probing table. (Some details are omitted here).</li>
<li>There are still some extra data materialization costs and data movement that could be saved by careful optimizations. They take almost half of the time due to frequent CPU-GPU data transfer.</li>
</ul>
<h1 id="primary-concerns">Primary Concerns</h1>
<p>We are concerned about the excessive complexity of our framework (data loading, plan building and expression evaluation). It now poses non-neglegible debugging overheads to us.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>